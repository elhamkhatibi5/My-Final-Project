<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width,initial-scale=1" />  
<title>🎓 Pocket Classroom — Mini E-Learning Platform</title>  
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">  
<style>  
  :root{  
    --bg:#0f1720; --card:#0b1220; --muted:#9aa4b2; --accent:#0ea5a4;  
  }  
  body{background:var(--bg); color:#e6eef6; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}  
  .app-shell{min-height:100vh; display:grid; grid-template-columns: 1fr 360px; gap:20px; padding:20px;}  
  .main-col{display:flex; flex-direction:column; gap:18px;}  
  header.navbar{background:linear-gradient(90deg,#083042,#0b2540); border-radius:12px; padding:12px 18px;}  
  .brand{font-weight:700; font-size:1.15rem;}  
  .card-panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.03);}  
  .library-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px;}  
  .capsule-card{background:var(--card); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.03);}  
  .muted{color:var(--muted); font-size:0.9rem;}  
  .tag{background:rgba(255,255,255,0.04); color:var(--muted); border-radius:999px; padding:4px 8px; font-size:0.75rem; margin-right:6px;}  
  .btn-pill{border-radius:999px;}  
  .small-input{height:36px;}  
  .notes-panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04)); border-radius:12px; padding:12px; height:calc(100vh - 160px); overflow:auto;}  
  textarea#notes{width:100%; min-height:320px; resize:vertical; background:transparent; color:inherit; border:1px dashed rgba(255,255,255,0.04); padding:12px; border-radius:8px;}  
  .flashcard-item{background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; margin-bottom:8px;}  
  .learn-card{min-height:180px;}  
  footer{opacity:0.6; font-size:0.85rem;}  
  .kbd{background:rgba(255,255,255,0.03); padding:4px 8px; border-radius:6px; font-size:0.9rem;}  
  @media (max-width: 900px){  
    .app-shell{grid-template-columns: 1fr; padding:12px;}  
    .notes-panel{height:280px;}  
  }  
</style>  
</head>  
<body>  <div class="container-fluid">  
  <div class="app-shell">  <!-- LEFT / MAIN COLUMN -->  
<div class="main-col">  

  <!-- Header / Nav -->  
  <header class="navbar card-panel d-flex align-items-center justify-content-between">  
    <div class="d-flex gap-3 align-items-center">  
      <div class="brand">🎓 Pocket Classroom</div>  
      <nav>  
        <button class="btn btn-sm btn-outline-light btn-pill nav-btn active" data-section="library">Library</button>  
        <button class="btn btn-sm btn-outline-light btn-pill nav-btn" data-section="author">Create</button>  
        <button class="btn btn-sm btn-outline-light btn-pill nav-btn" data-section="learn">Study</button>  
      </nav>  
    </div>  

    <div class="d-flex gap-2 align-items-center">  
      <input id="global-search" class="form-control form-control-sm small-input" placeholder="Search capsules, tags..." />  
      <select id="sort-select" class="form-select form-select-sm small-input" style="width:170px;">  
        <option value="date-desc">Newest first</option>  
        <option value="date-asc">Oldest first</option>  
        <option value="title-asc">Title A→Z</option>  
        <option value="title-desc">Title Z→A</option>  
      </select>  
      <button id="export-all" class="btn btn-sm btn-success btn-pill">Export</button>  
      <button id="import-all" class="btn btn-sm btn-secondary btn-pill">Import</button>  
      <input id="file-import" type="file" accept=".json" style="display:none">  
    </div>  
  </header>  

  <!-- Library Section -->  
  <section id="library" class="card-panel">  
    <div class="d-flex justify-content-between align-items-center mb-3">  
      <h4 class="mb-0">Your Library</h4>  
      <div class="muted">Capsules: <span id="capsule-count">0</span></div>  
    </div>  

    <div id="library-list" class="library-grid"></div>  

    <div id="empty-state" class="text-center muted mt-4">  
      No capsules yet. Click <span class="kbd">Create</span> to add your first learning capsule.  
    </div>  
  </section>  

  <!-- Author / Create Section -->  
  <section id="author" class="card-panel d-none">  
    <div class="d-flex justify-content-between align-items-center mb-3">  
      <h4 class="mb-0">Create / Edit Capsule</h4>  
      <div class="muted">Type: <span id="capsule-type-label">Note</span></div>  
    </div>  

    <form id="capsule-form">  
      <input type="hidden" id="editing-index" value="">  
      <div class="mb-2">  
        <label class="muted">Title</label>  
        <input id="capsule-title" class="form-control" placeholder="e.g., Intro to Photosynthesis" required>  
      </div>  

      <div class="mb-2 d-flex gap-2">  
        <div style="flex:1">  
          <label class="muted">Tags (comma separated)</label>  
          <input id="capsule-tags" class="form-control" placeholder="e.g., Biology, Plant">  
        </div>  
        <div style="width:200px">  
          <label class="muted">Capsule type</label>  
          <select id="capsule-type" class="form-select">  
            <option value="note">Note</option>  
            <option value="flashcards">Flashcards</option>  
            <option value="quiz">Quiz (multiple choice)</option>  
          </select>  
        </div>  
      </div>  

      <div id="note-content-wrapper" class="mb-2">  
        <label class="muted">Content (for Notes)</label>  
        <textarea id="capsule-content" class="form-control" rows="4" placeholder="Write summary, lecture notes, or instructions..."></textarea>  
      </div>  

      <!-- Flashcards builder -->  
      <div id="flashcards-wrapper" class="mb-2 d-none">  
        <label class="muted">Flashcards</label>  
        <div id="flashcards-list" class="mb-2"></div>  
        <div class="d-flex gap-2">  
          <input id="fc-front" class="form-control" placeholder="Front (question/term)">  
          <input id="fc-back" class="form-control" placeholder="Back (answer/definition)">  
          <button id="add-fc" type="button" class="btn btn-primary btn-pill">Add</button>  
        </div>  
      </div>  

      <!-- Quiz builder -->  
      <div id="quiz-wrapper" class="mb-2 d-none">  
        <label class="muted">Quiz Questions</label>  
        <div id="quiz-list" class="mb-2"></div>  
        <div class="d-flex gap-2">  
          <input id="q-text" class="form-control" placeholder="Question text">  
          <input id="q-opt1" class="form-control" placeholder="Option A">  
          <input id="q-opt2" class="form-control" placeholder="Option B">  
        </div>  
        <div class="d-flex gap-2 mt-2">  
          <input id="q-opt3" class="form-control" placeholder="Option C (optional)">  
          <input id="q-opt4" class="form-control" placeholder="Option D (optional)">  
          <select id="q-correct" class="form-select" style="width:120px;">  
            <option value="1">A</option><option value="2">B</option><option value="3">C</option><option value="4">D</option>  
          </select>  
          <button id="add-q" type="button" class="btn btn-primary btn-pill">Add Q</button>  
        </div>  
      </div>  

      <div class="d-flex gap-2 mt-3">  
        <button class="btn btn-success btn-pill" type="submit">Save Capsule</button>  
        <button id="cancel-edit" type="button" class="btn btn-outline-light btn-pill">Cancel</button>  
        <button id="new-capsule" type="button" class="btn btn-secondary btn-pill ms-auto">New Capsule</button>  
      </div>  
    </form>  
  </section>  

  <!-- Learn / Study Section -->  
  <section id="learn" class="card-panel d-none">  
    <div class="d-flex justify-content-between align-items-center mb-3">  
      <h4 class="mb-0">Study</h4>  
      <div class="muted">Mode: <span id="study-mode">Flashcards</span></div>  
    </div>  

    <div id="study-controls" class="mb-3 d-flex gap-2 align-items-center">  
      <select id="study-capsule-select" class="form-select" style="width:300px;">  
        <option value="">Choose a capsule to study...</option>  
      </select>  
      <button id="start-study" class="btn btn-primary btn-pill">Start</button>  
      <button id="shuffle-study" class="btn btn-outline-light btn-pill">Shuffle</button>  
      <div class="muted ms-auto">Progress: <span id="study-progress">0 / 0</span></div>  
    </div>  

    <div id="study-area" class="learn-card card-panel">  
      <div id="study-empty" class="muted">Select a capsule and press Start to begin studying flashcards or quizzes.</div>  

      <div id="flashcard-study" class="d-none">  
        <div class="mb-2 muted small" id="fc-meta"></div>  
        <div id="fc-front-display" class="h5 fw-bold mb-2"></div>  
        <div id="fc-back-display" class="muted mb-3" style="display:none"></div>  
        <div class="d-flex gap-2">  
          <button id="show-answer" class="btn btn-outline-light btn-pill">Show Answer</button>  
          <button id="mark-learned" class="btn btn-success btn-pill">Mark Learned</button>  
          <button id="next-card" class="btn btn-secondary btn-pill ms-auto">Next</button>  
        </div>  
      </div>  

      <div id="quiz-study" class="d-none">  
        <div id="q-text-display" class="h5 fw-bold mb-2"></div>  
        <div id="q-options" class="d-flex flex-column gap-2 mb-3"></div>  
        <div class="d-flex gap-2">  
          <button id="q-next" class="btn btn-secondary btn-pill ms-auto">Next</button>  
        </div>  
        <div id="q-feedback" class="mt-2 muted"></div>  
      </div>  

    </div>  
  </section>  

  <footer class="text-center muted mt-2">  
    © 2025 Pocket Classroom — Offline · LocalStorage · Export/Import JSON  
  </footer>  
</div>  

<!-- RIGHT / NOTES PANEL -->  
<aside class="notes-panel">  
  <div class="d-flex justify-content-between align-items-center mb-2">  
    <h5 class="mb-0">Quick Notes</h5>  
    <div class="muted small">Autosaved</div>  
  </div>  
  <textarea id="notes" placeholder="Type quick study notes, TODOs, reminders..."></textarea>  

  <div class="mt-3">  
    <div class="d-flex justify-content-between align-items-center mb-2">  
      <h6 class="mb-0">Recent Imports / Exports</h6>  
      <button id="clear-logs" class="btn btn-sm btn-outline-light btn-pill">Clear</button>  
    </div>  
    <ul id="io-log" class="list-unstyled muted small" style="max-height:220px; overflow:auto;"></ul>  
  </div>  
</aside>

  </div>  
</div>  <script type="module">  
/*  
  Pocket Classroom — single file JS  
  Features implemented:  
  - LocalStorage persistence for capsules + notes  
  - Create / Edit / Delete / Duplicate capsules  
  - Flashcards builder + Quiz builder  
  - Study mode: Flashcards (show answer, mark learned), Quiz (MCQ)  
  - Import / Export JSON (full library)  
  - Sidebar notes autosave  
*/  
  
const LS_KEY = 'pc_capsules_v1';  
const LS_NOTES = 'pc_notes_v1';  
const LS_IOLOG = 'pc_iolog_v1';  
  
let app = {  
  capsules: [],  
  notes: '',  
  ioLog: []  
};  
  
function uid(){ return Math.random().toString(36).slice(2,9); }  
  
/* --- Storage --- */  
function loadState(){  
  try{  
    const raw = localStorage.getItem(LS_KEY);  
    app.capsules = raw ? JSON.parse(raw) : [];  
  }catch(e){ app.capsules = []; }  
  app.notes = localStorage.getItem(LS_NOTES) || '';  
  try{ app.ioLog = JSON.parse(localStorage.getItem(LS_IOLOG)) || []; }catch(e){ app.ioLog = []; }  
}  
function saveState(){  
  localStorage.setItem(LS_KEY, JSON.stringify(app.capsules));  
}  
function saveNotes(){  
  localStorage.setItem(LS_NOTES, app.notes);  
}  
function saveIoLog(){  
  localStorage.setItem(LS_IOLOG, JSON.stringify(app.ioLog));  
}  
  
/* --- UI refs --- */  
const sections = {  
  library: document.getElementById('library'),  
  author: document.getElementById('author'),  
  learn: document.getElementById('learn')  
};  
const navBtns = document.querySelectorAll('.nav-btn');  
const libraryList = document.getElementById('library-list');  
const capsuleCount = document.getElementById('capsule-count');  
const emptyState = document.getElementById('empty-state');  
const globalSearch = document.getElementById('global-search');  
const sortSelect = document.getElementById('sort-select');  
const exportAllBtn = document.getElementById('export-all');  
const importAllBtn = document.getElementById('import-all');  
const fileImport = document.getElementById('file-import');  
  
/* Author elements */  
const capsuleForm = document.getElementById('capsule-form');  
const editingIndex = document.getElementById('editing-index');  
const titleInput = document.getElementById('capsule-title');  
const tagsInput = document.getElementById('capsule-tags');  
const typeSelect = document.getElementById('capsule-type');  
const typeLabel = document.getElementById('capsule-type-label');  
const noteContentWrapper = document.getElementById('note-content-wrapper');  
const capsuleContent = document.getElementById('capsule-content');  
const flashWrapper = document.getElementById('flashcards-wrapper');  
const flashList = document.getElementById('flashcards-list');  
const fcFront = document.getElementById('fc-front');  
const fcBack = document.getElementById('fc-back');  
const addFcBtn = document.getElementById('add-fc');  
const quizWrapper = document.getElementById('quiz-wrapper');  
const quizList = document.getElementById('quiz-list');  
const qText = document.getElementById('q-text');  
const qOpt1 = document.getElementById('q-opt1');  
const qOpt2 = document.getElementById('q-opt2');  
const qOpt3 = document.getElementById('q-opt3');  
const qOpt4 = document.getElementById('q-opt4');  
const qCorrect = document.getElementById('q-correct');  
const addQBtn = document.getElementById('add-q');  
const cancelEditBtn = document.getElementById('cancel-edit');  
const newCapsuleBtn = document.getElementById('new-capsule');  
  
/* Learn elements */  
const studySelect = document.getElementById('study-capsule-select');  
const startStudyBtn = document.getElementById('start-study');  
const shuffleBtn = document.getElementById('shuffle-study');  
const studyArea = document.getElementById('study-area');  
const studyEmpty = document.getElementById('study-empty');  
const flashStudy = document.getElementById('flashcard-study');  
const fcMeta = document.getElementById('fc-meta');  
const fcFrontDisplay = document.getElementById('fc-front-display');  
const fcBackDisplay = document.getElementById('fc-back-display');  
const showAnswerBtn = document.getElementById('show-answer');  
const markLearnedBtn = document.getElementById('mark-learned');  
const nextCardBtn = document.getElementById('next-card');  
const quizStudy = document.getElementById('quiz-study');  
const qTextDisplay = document.getElementById('q-text-display');  
const qOptions = document.getElementById('q-options');  
const qFeedback = document.getElementById('q-feedback');  
const qNextBtn = document.getElementById('q-next');  
const studyProgress = document.getElementById('study-progress');  
const studyModeLabel = document.getElementById('study-mode');  
  
/* Notes */  
const notesArea = document.getElementById('notes');  
const ioLogEl = document.getElementById('io-log');  
const clearLogs = document.getElementById('clear-logs');  
  
/* State for study */  
let studyState = {  
  capsuleId: null,  
  items: [],  
  index: 0,  
  learned: new Set(),  
  mode: 'flashcards' // or 'quiz'  
};  
  
/* --- Utilities --- */  
function formatDate(ts){ return new Date(ts).toLocaleString(); }  
function parseTags(str){ return str.split(',').map(s=>s.trim()).filter(Boolean); }  
function addIoLog(text){  
  app.ioLog.unshift({id:uid(), text, at: Date.now()});  
  if(app.ioLog.length>50) app.ioLog.pop();  
  saveIoLog(); renderIoLog();  
}  
  
/* --- Render Library --- */  
function renderLibrary(){  
  const q = globalSearch.value.trim().toLowerCase();  
  const sort = sortSelect.value;  
  let list = [...app.capsules];  
  
  if(q){  
    list = list.filter(c => c.title.toLowerCase().includes(q) || (c.tags||[]).join(' ').toLowerCase().includes(q) || (c.content||'').toLowerCase().includes(q));  
  }  
  if(sort==='date-desc') list.sort((a,b)=>b.createdAt - a.createdAt);  
  if(sort==='date-asc') list.sort((a,b)=>a.createdAt - b.createdAt);  
  if(sort==='title-asc') list.sort((a,b)=>a.title.localeCompare(b.title));  
  if(sort==='title-desc') list.sort((a,b)=>b.title.localeCompare(a.title));  
  
  libraryList.innerHTML = '';  
  if(list.length===0){ emptyState.style.display='block'; } else { emptyState.style.display='none'; }  
  
  list.forEach((c, idx) => {  
    const card = document.createElement('div');  
    card.className = 'capsule-card';  
    card.innerHTML = `  
      <div class="d-flex justify-content-between align-items-start mb-2">  
        <div>  
          <div class="fw-bold">${escapeHtml(c.title)}</div>  
          <div class="muted small">${formatDate(c.createdAt)}</div>  
        </div>  
        <div class="text-end">  
          <div class="muted small">${c.type}</div>  
        </div>  
      </div>  
      <div class="mb-2 muted small">${escapeHtml((c.content||'').slice(0,140))}${(c.content&&c.content.length>140)?'...':''}</div>  
      <div class="mb-2">  
        ${(c.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ')}  
      </div>  
      <div class="d-flex gap-2 mt-2">  
        <button class="btn btn-sm btn-outline-light btn-pill btn-edit" data-i="${c.id}">Edit</button>  
        <button class="btn btn-sm btn-danger btn-pill ms-auto btn-delete" data-i="${c.id}">Delete</button>  
        <button class="btn btn-sm btn-secondary btn-pill btn-dup" data-i="${c.id}">Duplicate</button>  
        <button class="btn btn-sm btn-success btn-pill btn-study" data-i="${c.id}">Study</button>  
        <button class="btn btn-sm btn-warning btn-pill btn-export" data-i="${c.id}">Export</button>  
      </div>  
    `;  
    libraryList.appendChild(card);  
  });  
  
  capsuleCount.textContent = app.capsules.length;  
  renderStudySelect();  
}  
  
/* --- Render study select --- */  
function renderStudySelect(){  
  studySelect.innerHTML = '<option value="">Choose a capsule to study...</option>';  
  app.capsules.forEach(c => {  
    const opt = document.createElement('option');  
    opt.value = c.id;  
    opt.textContent = `${c.title} — ${c.type}`;  
    studySelect.appendChild(opt);  
  });  
}  
  
/* --- Escape helper --- */  
function escapeHtml(s=''){ return s.replaceAll('<','&lt;').replaceAll('>','&gt;'); }  
  
/* --- Author helpers --- */  
function clearAuthorForm(){  
  editingIndex.value = '';  
  titleInput.value = '';  
  tagsInput.value = '';  
  capsuleContent.value = '';  
  flashList.innerHTML = '';  
  quizList.innerHTML = '';  
  fcFront.value = ''; fcBack.value = '';  
  qText.value=''; qOpt1.value=''; qOpt2.value=''; qOpt3.value=''; qOpt4.value=''; qCorrect.value='1';  
  typeSelect.value = 'note';  
  toggleTypeUI('note');  
}  
  
function toggleTypeUI(t){  
  typeLabel.textContent = t.charAt(0).toUpperCase() + t.slice(1);  
  noteContentWrapper.classList.toggle('d-none', t!=='note');  
  flashWrapper.classList.toggle('d-none', t!=='flashcards');  
  quizWrapper.classList.toggle('d-none', t!=='quiz');  
}  
  
/* --- Flashcards list render --- */  
function renderFlashList(items){  
  flashList.innerHTML = '';  
  (items||[]).forEach((f, idx) => {  
    const el = document.createElement('div'); el.className = 'flashcard-item d-flex align-items-start justify-content-between';  
    el.innerHTML = `<div><div class="fw-bold">${escapeHtml(f.front)}</div><div class="muted small">${escapeHtml(f.back)}</div></div>  
      <div><button class="btn btn-sm btn-outline-light btn-pill btn-del-fc" data-i="${idx}">Delete</button></div>`;  
    flashList.appendChild(el);  
  });  
}  
  
/* --- Quiz list render --- */  
function renderQuizList(items){  
  quizList.innerHTML = '';  
  (items||[]).forEach((q, idx) => {  
    const el = document.createElement('div'); el.className = 'flashcard-item';  
    el.innerHTML = `<div class="fw-bold">${escapeHtml(q.text)}</div>  
      <div class="muted small">A:${escapeHtml(q.opts[0]||'')} B:${escapeHtml(q.opts[1]||'')} C:${escapeHtml(q.opts[2]||'')} D:${escapeHtml(q.opts[3]||'')}</div>  
      <div class="mt-2"><button class="btn btn-sm btn-outline-light btn-pill btn-del-q" data-i="${idx}">Delete</button></div>`;  
    quizList.appendChild(el);  
  });  
}  
  
/* --- CRUD: Create / Update / Delete --- */  
function saveCapsuleFromForm(e){  
  e.preventDefault();  
  const idEditing = editingIndex.value || null;  
  const title = titleInput.value.trim();  
  const tags = parseTags(tagsInput.value);  
  const type = typeSelect.value;  
  const now = Date.now();  
  
  let capsule = {  
    id: idEditing || uid(),  
    title, tags, type, createdAt: now, updatedAt: now  
  };  
  
  if(type==='note'){ capsule.content = capsuleContent.value.trim(); capsule.data = []; }  
  if(type==='flashcards'){   
    const items = gatherFlashcardsFromUI();  
    capsule.data = items;  
    capsule.content = '';  
  }  
  if(type==='quiz'){  
    capsule.data = gatherQuizFromUI();  
    capsule.content = '';  
  }  
  
  if(idEditing){  
    // update existing  
    const i = app.capsules.findIndex(c=>c.id===idEditing);  
    if(i!==-1){ capsule.createdAt = app.capsules[i].createdAt; app.capsules[i] = {...app.capsules[i], ...capsule, updatedAt: now}; }  
  }else{  
    app.capsules.push(capsule);  
  }  
  saveState();  
  addIoLog(`Saved capsule "${title}"`);  
  renderLibrary();  
  clearAuthorForm();  
  showSection('library');  
}  
  
function gatherFlashcardsFromUI(){  
  const items = [];  
  flashList.querySelectorAll('.flashcard-item').forEach((el, idx) => {  
    const front = el.querySelector('.fw-bold')?.textContent || '';  
    const back = el.querySelector('.muted')?.textContent || '';  
    // saved earlier only by UI actions, so we'll rely on form-stored array  
  });  
  // Alternative: store temp array on element dataset  
  return window._tmpFlashcards || [];  
}  
function gatherQuizFromUI(){ return window._tmpQuiz || []; }  
  
/* --- Add flashcard/quiz handlers --- */  
addFcBtn.addEventListener('click', ()=>{  
  const f = fcFront.value.trim(), b = fcBack.value.trim();  
  if(!f || !b) return alert('Please enter both front and back of flashcard.');  
  window._tmpFlashcards = window._tmpFlashcards || [];  
  window._tmpFlashcards.push({front:f, back:b, id:uid()});  
  renderFlashList(window._tmpFlashcards);  
  fcFront.value=''; fcBack.value=''; fcFront.focus();  
});  
  
addQBtn.addEventListener('click', ()=>{  
  const text = qText.value.trim();  
  if(!text || !qOpt1.value.trim() || !qOpt2.value.trim()) return alert('Question and at least options A and B required.');  
  window._tmpQuiz = window._tmpQuiz || [];  
  const opts = [qOpt1.value.trim(), qOpt2.value.trim(), qOpt3.value.trim()||'', qOpt4.value.trim()||''];  
  window._tmpQuiz.push({text, opts, correct: Number(qCorrect.value), id:uid()});  
  renderQuizList(window._tmpQuiz);  
  qText.value=''; qOpt1.value=''; qOpt2.value=''; qOpt3.value=''; qOpt4.value=''; qCorrect.value='1';  
});  
  
/* Delete flashcard/quiz from UI lists */  
document.addEventListener('click', (ev)=>{  
  if(ev.target.matches('.btn-del-fc')){  
    const i = Number(ev.target.dataset.i);  
    if(window._tmpFlashcards && window._tmpFlashcards[i]){ window._tmpFlashcards.splice(i,1); renderFlashList(window._tmpFlashcards); }  
  }  
  if(ev.target.matches('.btn-del-q')){  
    const i = Number(ev.target.dataset.i);  
    if(window._tmpQuiz && window._tmpQuiz[i]){ window._tmpQuiz.splice(i,1); renderQuizList(window._tmpQuiz); }  
  }  
});  
  
/* --- Library buttons (edit/delete/dup/study/export) --- */  
libraryList.addEventListener('click', (ev)=>{  
  const btn = ev.target;  
  if(btn.matches('.btn-delete')){  
    const id = btn.dataset.i;  
    if(confirm('Delete capsule? This cannot be undone.')){  
      app.capsules = app.capsules.filter(c=>c.id!==id);  
      saveState(); addIoLog(`Deleted capsule ${id}`); renderLibrary();  
    }  
  }  
  if(btn.matches('.btn-edit')){  
    const id = btn.dataset.i; openEdit(id);  
  }  
  if(btn.matches('.btn-dup')){  
    const id = btn.dataset.i; duplicateCapsule(id);  
  }  
  if(btn.matches('.btn-study')){  
    const id = btn.dataset.i; studySelect.value = id; startStudyFromId(id);  
  }  
  if(btn.matches('.btn-export')){  
    const id = btn.dataset.i; exportCapsule(id);  
  }  
});  
  
function openEdit(id){  
  const cap = app.capsules.find(c=>c.id===id); if(!cap) return;  
  showSection('author');  
  editingIndex.value = cap.id;  
  titleInput.value = cap.title;  
  tagsInput.value = (cap.tags||[]).join(', ');  
  typeSelect.value = cap.type || 'note';  
  toggleTypeUI(typeSelect.value);  
  if(cap.type==='note'){  
    capsuleContent.value = cap.content || '';  
  } else if(cap.type==='flashcards'){  
    window._tmpFlashcards = JSON.parse(JSON.stringify(cap.data||[]));  
    renderFlashList(window._tmpFlashcards);  
  } else if(cap.type==='quiz'){  
    window._tmpQuiz = JSON.parse(JSON.stringify(cap.data||[]));  
    renderQuizList(window._tmpQuiz);  
  }  
}  
  
function duplicateCapsule(id){  
  const orig = app.capsules.find(c=>c.id===id); if(!orig) return;  
  const copy = {...orig, id: uid(), title: orig.title + ' (copy)', createdAt: Date.now(), updatedAt: Date.now()};  
  app.capsules.push(copy); saveState(); addIoLog(`Duplicated "${orig.title}"`); renderLibrary();  
}  
  
function exportCapsule(id){  
  const cap = app.capsules.find(c=>c.id===id); if(!cap) return;  
  const blob = new Blob([JSON.stringify(cap, null, 2)], {type:'application/json'});  
  const url = URL.createObjectURL(blob);  
  const a = document.createElement('a'); a.href=url; a.download = `${cap.title.replace(/\s+/g,'_')}.json`; a.click();  
  URL.revokeObjectURL(url);  
  addIoLog(`Exported capsule "${cap.title}"`);  
}  
  
/* --- Import / Export library --- */  
exportAllBtn.addEventListener('click', ()=>{  
  const blob = new Blob([JSON.stringify(app.capsules, null, 2)], {type:'application/json'});  
  const url = URL.createObjectURL(blob);  
  const a = document.createElement('a'); a.href=url; a.download = `pocket_classroom_export_${Date.now()}.json`; a.click();  
  URL.revokeObjectURL(url);  
  addIoLog('Exported full library');  
});  
  
importAllBtn.addEventListener('click', ()=> fileImport.click());  
fileImport.addEventListener('change', handleFileImport);  
  
function handleFileImport(e){  
  const f = e.target.files[0]; if(!f) return;  
  const reader = new FileReader();  
  reader.onload = (ev)=>{  
    try{  
      const data = JSON.parse(ev.target.result);  
      if(Array.isArray(data)){  
        // merge by id uniqueness  
        const existingIds = new Set(app.capsules.map(c=>c.id));  
        data.forEach(c=>{  
          if(!existingIds.has(c.id)){ app.capsules.push(c); }  
        });  
        saveState(); renderLibrary(); addIoLog('Imported library (array)');  
      }else if(data && data.id){  
        // single capsule import  
        if(!app.capsules.find(x=>x.id===data.id)) app.capsules.push(data);  
        saveState(); renderLibrary(); addIoLog(`Imported capsule "${data.title}"`);  
      }else{  
        alert('Invalid import file.');  
      }  
    }catch(err){ alert('Failed to parse JSON file.'); }  
  };  
  reader.readAsText(f);  
  e.target.value = '';  
}  
  
/* --- Study: start --- */  
function startStudyFromId(id){  
  const cap = app.capsules.find(c=>c.id===id); if(!cap) return;  
  studyState.capsuleId = id;  
  studyState.index = 0;  
  studyState.learned = new Set();  
  
  if(cap.type==='flashcards'){ studyState.mode='flashcards'; studyState.items = (cap.data||[]).map(x=>({...x})); showFlashStudy(); }  
  else if(cap.type==='quiz'){ studyState.mode='quiz'; studyState.items = (cap.data||[]).map(x=>({...x})); showQuizStudy(); }  
  else { alert('This capsule is not studyable (note-only).'); return; }  
  
  studyModeLabel.textContent = studyState.mode==='flashcards' ? 'Flashcards':'Quiz';  
  studyProgress.textContent = `0 / ${studyState.items.length}`;  
}  
  
/* UI: Start button from select */  
startStudyBtn.addEventListener('click', ()=>{  
  const id = studySelect.value;  
  if(!id) return alert('Choose a capsule to study.');  
  startStudyFromId(id);  
});  
  
/* Shuffle */  
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }  
shuffleBtn.addEventListener('click', ()=>{  
  if(studyState.items.length) { shuffleArray(studyState.items); studyState.index=0; addIoLog('Shuffled study items'); renderStudyCard(); }  
});  
  
/* show flash / quiz UI */  
function showFlashStudy(){  
  studyEmpty.style.display='none';  
  flashStudy.classList.remove('d-none');  
  quizStudy.classList.add('d-none');  
  renderStudyCard();  
}  
function showQuizStudy(){  
  studyEmpty.style.display='none';  
  quizStudy.classList.remove('d-none');  
  flashStudy.classList.add('d-none');  
  renderStudyCard();  
}  
  
/* render single study card */  
function renderStudyCard(){  
  const items = studyState.items;  
  const idx = studyState.index;  
  if(!items || items.length===0){  
    studyEmpty.style.display='block'; flashStudy.classList.add('d-none'); quizStudy.classList.add('d-none');  
    studyProgress.textContent = `0 / 0`; return;  
  }  
  studyEmpty.style.display='none';  
  studyProgress.textContent = `${studyState.learned.size} / ${items.length}`;  
  
  if(studyState.mode==='flashcards'){  
    const cur = items[idx];  
    fcMeta.textContent = `Card ${idx+1} of ${items.length}`;  
    fcFrontDisplay.textContent = cur.front || cur.question || '';  
    fcBackDisplay.textContent = cur.back || cur.answer || '';  
    fcBackDisplay.style.display='none';  
  }else{  
    const cur = items[idx];  
    qTextDisplay.textContent = cur.text || '';  
    qOptions.innerHTML = '';  
    (cur.opts||[]).forEach((o, i)=>{  
      if(!o) return;  
      const btn = document.createElement('button'); btn.className = 'btn btn-outline-light btn-pill text-start';  
      btn.style.width='100%';  
      btn.textContent = String.fromCharCode(65+i) + '. ' + o;  
      btn.dataset.opt = i+1;  
      btn.addEventListener('click', ()=>{  
        const chosen = Number(btn.dataset.opt);  
        if(chosen === cur.correct){ qFeedback.textContent = 'Correct ✅'; qFeedback.style.color = 'lightgreen'; }  
        else { qFeedback.textContent = `Wrong — correct is ${String.fromCharCode(64+cur.correct)}.`; qFeedback.style.color = '#ffb3b3'; }  
        // disable options  
        Array.from(qOptions.children).forEach(b=>b.disabled=true);  
      });  
      qOptions.appendChild(btn);  
    });  
    qFeedback.textContent='';  
  }  
}  
  
/* show answer / next / mark learned */  
showAnswerBtn.addEventListener('click', ()=>{ fcBackDisplay.style.display='block'; });  
markLearnedBtn.addEventListener('click', ()=>{  
  studyState.learned.add(studyState.index);  
  studyProgress.textContent = `${studyState.learned.size} / ${studyState.items.length}`;  
});  
nextCardBtn.addEventListener('click', ()=>{  
  if(studyState.index < studyState.items.length -1) studyState.index++;  
  else studyState.index = 0;  
  renderStudyCard();  
});  
qNextBtn.addEventListener('click', ()=>{  
  if(studyState.index < studyState.items.length -1) studyState.index++;  
  else studyState.index = 0;  
  renderStudyCard();  
});  
  
/* --- Notes and IO log --- */  
notesArea.addEventListener('input', (e)=>{ app.notes = e.target.value; saveNotes(); });  
function renderIoLog(){  
  ioLogEl.innerHTML = '';  
  app.ioLog.forEach(entry=>{  
    const li = document.createElement('li');  
    li.innerHTML = `<div class="fw-bold small">${new Date(entry.at).toLocaleString()}</div><div class="muted small">${escapeHtml(entry.text)}</div>`;  
    ioLogEl.appendChild(li);  
  });  
}  
clearLogs.addEventListener('click', ()=>{ app.ioLog = []; saveIoLog(); renderIoLog(); });  
  
/* --- Misc UI wiring --- */  
navBtns.forEach(b=> b.addEventListener('click', ()=> showSection(b.dataset.section)));  
function showSection(name){  
  Object.keys(sections).forEach(k=> sections[k].classList.toggle('d-none', k!==name));  
  navBtns.forEach(nb => nb.classList.toggle('active', nb.dataset.section===name));  
}  
  
/* type selector */  
typeSelect.addEventListener('change', (e)=> toggleTypeUI(e.target.value));  
  
/* Search & sort */  
globalSearch.addEventListener('input', renderLibrary);  
sortSelect.addEventListener('change', renderLibrary);  
  
/* capsule form submit */  
capsuleForm.addEventListener('submit', saveCapsuleFromForm);  
  
/* cancel / new */  
cancelEditBtn.addEventListener('click', ()=> { clearAuthorForm(); showSection('library'); });  
newCapsuleBtn.addEventListener('click', clearAuthorForm);  
  
/* study select quick start by double click on library? handled earlier */  
  
/* initial load */  
function initSampleIfEmpty(){  
  if(app.capsules.length===0){  
    const sample = [  
      {id:uid(), title:'Biology — Photosynthesis', tags:['Biology','Plants'], type:'note', content:'Photosynthesis is the process by which plants convert light to energy...', data:[], createdAt:Date.now()-86400000, updatedAt:Date.now()-86400000},  
      {id:uid(), title:'Basic Spanish — Vocabulary', tags:['Spanish','Vocab'], type:'flashcards', content:'', data:[  
        {id:uid(), front:'Hello', back:'Hola'},  
        {id:uid(), front:'Thank you', back:'Gracias'},  
        {id:uid(), front:'Please', back:'Por favor'}  
      ], createdAt:Date.now()-3600000, updatedAt:Date.now()-3600000},  
      {id:uid(), title:'JS Quiz — Basics', tags:['JS','Quiz'], type:'quiz', content:'', data:[  
        {id:uid(), text:'Which keyword declares a variable block-scoped?', opts:['var','let','function','const'], correct:2, id:uid()},  
        {id:uid(), text:'Which method converts JSON string to object?', opts:['JSON.parse','JSON.stringify','Object.fromJSON','parseJSON'], correct:1, id:uid()}  
      ], createdAt:Date.now()-1800000, updatedAt:Date.now()-1800000}  
    ];  
    app.capsules = sample;  
    saveState();  
    addIoLog('Loaded sample capsules');  
  }  
}  
  
/* open edit via global handler: when clicking edit etc. done above */  
  
/* export single capsule via header (not implemented) */  
  
/* load everything */  
loadState();  
initSampleIfEmpty();  
renderLibrary();  
notesArea.value = app.notes || '';  
renderIoLog();  
  
/* small helper to reset tmp arrays when switching */  
document.querySelectorAll('.nav-btn').forEach(b=> b.addEventListener('click', ()=> { window._tmpFlashcards=[]; window._tmpQuiz=[]; }));  
  /* --- Import / Export library --- */
exportAllBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(app.capsules, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pocket_classroom_library.json';
  a.click();
  URL.revokeObjectURL(url);
  addIoLog('Exported full library');
});

importAllBtn.addEventListener('click', ()=> fileImport.click());
fileImport.addEventListener('change', async (ev)=>{
  const file = ev.target.files[0];
  if(!file) return;
  const text = await file.text();
  try{
    const imported = JSON.parse(text);
    if(Array.isArray(imported)){
      app.capsules = imported;
      saveState();
      renderLibrary();
      addIoLog(`Imported ${imported.length} capsules`);
    } else {
      alert('Invalid JSON structure.');
    }
  }catch(e){
    alert('Error reading file: ' + e.message);
  }
  fileImport.value = '';
});

/* --- Notes autosave --- */
notesArea.value = app.notes;
notesArea.addEventListener('input', ()=>{
  app.notes = notesArea.value;
  saveNotes();
});

/* --- IO Log --- */
function renderIoLog(){
  ioLogEl.innerHTML = app.ioLog.map(log=>`<li>[${new Date(log.at).toLocaleTimeString()}] ${escapeHtml(log.text)}</li>`).join('');
}
clearLogs.addEventListener('click', ()=>{
  app.ioLog = [];
  saveIoLog();
  renderIoLog();
});

/* --- Study section --- */
function startStudyFromId(id){
  const cap = app.capsules.find(c=>c.id===id);
  if(!cap){ alert('Capsule not found.'); return; }

  studyState.capsuleId = cap.id;
  studyState.index = 0;
  studyState.learned = new Set();
  studyModeLabel.textContent = cap.type.charAt(0).toUpperCase() + cap.type.slice(1);

  if(cap.type === 'flashcards'){
    studyState.mode = 'flashcards';
    studyState.items = [...(cap.data || [])];
    showFlashcardStudy();
  } else if(cap.type === 'quiz'){
    studyState.mode = 'quiz';
    studyState.items = [...(cap.data || [])];
    showQuizStudy();
  } else {
    studyState.mode = 'note';
    studyArea.innerHTML = `<div class="muted">This capsule is a note — review its content below:</div><div class="mt-3">${escapeHtml(cap.content || '')}</div>`;
    studyProgress.textContent = '—';
  }
}

function showFlashcardStudy(){
  studyEmpty.classList.add('d-none');
  quizStudy.classList.add('d-none');
  flashStudy.classList.remove('d-none');
  renderFlashcard();
}

function renderFlashcard(){
  const list = studyState.items;
  if(list.length === 0){
    fcFrontDisplay.textContent = 'No flashcards available.';
    fcBackDisplay.textContent = '';
    studyProgress.textContent = '0 / 0';
    return;
  }

  const idx = studyState.index % list.length;
  const card = list[idx];
  fcMeta.textContent = `Card ${idx+1} of ${list.length}`;
  fcFrontDisplay.textContent = card.front;
  fcBackDisplay.textContent = card.back;
  fcBackDisplay.style.display = 'none';
  studyProgress.textContent = `${studyState.learned.size} / ${list.length}`;
}

showAnswerBtn.addEventListener('click', ()=> fcBackDisplay.style.display = 'block');

markLearnedBtn.addEventListener('click', ()=>{
  const card = studyState.items[studyState.index];
  studyState.learned.add(card.id);
  studyProgress.textContent = `${studyState.learned.size} / ${studyState.items.length}`;
});

nextCardBtn.addEventListener('click', ()=>{
  studyState.index = (studyState.index + 1) % studyState.items.length;
  renderFlashcard();
});

shuffleBtn.addEventListener('click', ()=>{
  if(!studyState.items.length) return;
  studyState.items.sort(()=>Math.random() - 0.5);
  studyState.index = 0;
  if(studyState.mode === 'flashcards') renderFlashcard();
  if(studyState.mode === 'quiz') renderQuizQuestion();
});

/* --- Quiz study --- */
function showQuizStudy(){
  studyEmpty.classList.add('d-none');
  flashStudy.classList.add('d-none');
  quizStudy.classList.remove('d-none');
  renderQuizQuestion();
}

function renderQuizQuestion(){
  const list = studyState.items;
  if(list.length === 0){
    qTextDisplay.textContent = 'No questions available.';
    qOptions.innerHTML = '';
    return;
  }

  const idx = studyState.index % list.length;
  const q = list[idx];
  qTextDisplay.textContent = q.text;
  qFeedback.textContent = '';
  qOptions.innerHTML = '';

  q.opts.forEach((opt, i)=>{
    if(!opt) return;
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-light btn-pill text-start';
    btn.textContent = `${String.fromCharCode(65+i)}. ${opt}`;
    btn.addEventListener('click', ()=>{
      const correct = q.correct === i+1;
      qFeedback.textContent = correct ? '✅ Correct!' : `❌ Wrong. Correct answer: ${String.fromCharCode(64+q.correct)}`;
    });
    qOptions.appendChild(btn);
  });

  studyProgress.textContent = `${studyState.index+1} / ${list.length}`;
}

qNextBtn.addEventListener('click', ()=>{
  studyState.index = (studyState.index + 1) % studyState.items.length;
  renderQuizQuestion();
});

startStudyBtn.addEventListener('click', ()=>{
  const id = studySelect.value;
  if(!id) return alert('Choose a capsule to study.');
  startStudyFromId(id);
});

/* --- Navigation --- */
function showSection(name){
  Object.keys(sections).forEach(k=>{
    sections[k].classList.toggle('d-none', k!==name);
  });
  navBtns.forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.section === name);
  });
}

navBtns.forEach(btn=>{
  btn.addEventListener('click', ()=> showSection(btn.dataset.section));
});

/* --- Init --- */
loadState();
renderLibrary();
renderIoLog();
showSection('library');
</script>  </body>  
</html>
